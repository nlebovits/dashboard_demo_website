<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.247">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>lotsapp_demo_site – vacant_lots_layer</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">lotsapp_demo_site</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../take_action.html">
 <span class="menu-text">Take Action</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#imports" id="toc-imports" class="nav-link active" data-scroll-target="#imports">Imports</a>
  <ul class="collapse">
  <li><a href="#vacant-land" id="toc-vacant-land" class="nav-link" data-scroll-target="#vacant-land">1. Vacant Land</a></li>
  <li><a href="#vacant-buildings" id="toc-vacant-buildings" class="nav-link" data-scroll-target="#vacant-buildings">2. Vacant Buildings</a></li>
  <li><a href="#now-combine-the-two-datasets-in-preparation-for-string-cleaning." id="toc-now-combine-the-two-datasets-in-preparation-for-string-cleaning." class="nav-link" data-scroll-target="#now-combine-the-two-datasets-in-preparation-for-string-cleaning.">Now, combine the two datasets in preparation for string cleaning.</a></li>
  <li><a href="#now-well-apply-string-cleaning-to-the-owner1-and-owner2-columns-to-identify-public-vs.-private-ownership." id="toc-now-well-apply-string-cleaning-to-the-owner1-and-owner2-columns-to-identify-public-vs.-private-ownership." class="nav-link" data-scroll-target="#now-well-apply-string-cleaning-to-the-owner1-and-owner2-columns-to-identify-public-vs.-private-ownership.">Now we’ll apply string cleaning to the OWNER1 and OWNER2 columns to identify public vs.&nbsp;private ownership.</a></li>
  <li><a href="#phs-community-landcare-parcels" id="toc-phs-community-landcare-parcels" class="nav-link" data-scroll-target="#phs-community-landcare-parcels">3. PHS Community Landcare Parcels</a></li>
  <li><a href="#li-complaints" id="toc-li-complaints" class="nav-link" data-scroll-target="#li-complaints">1. L&amp;I Complaints</a></li>
  <li><a href="#li-code-violations" id="toc-li-code-violations" class="nav-link" data-scroll-target="#li-code-violations">2. L&amp;I Code Violations</a></li>
  <li><a href="#next-well-add-a-centroids-column-to-the-joined_gdf-in-order-to-make-it-easier-to-cleanly-join-neighborhoods-rcos-tree-canopy-and-guncrime-data." id="toc-next-well-add-a-centroids-column-to-the-joined_gdf-in-order-to-make-it-easier-to-cleanly-join-neighborhoods-rcos-tree-canopy-and-guncrime-data." class="nav-link" data-scroll-target="#next-well-add-a-centroids-column-to-the-joined_gdf-in-order-to-make-it-easier-to-cleanly-join-neighborhoods-rcos-tree-canopy-and-guncrime-data.">Next, we’ll add a centroids column to the joined_gdf in order to make it easier to cleanly join neighborhoods, RCOs, tree canopy, and guncrime data.</a></li>
  <li><a href="#import-philadelphias-neighborhoods-from-azavea" id="toc-import-philadelphias-neighborhoods-from-azavea" class="nav-link" data-scroll-target="#import-philadelphias-neighborhoods-from-azavea">Import Philadelphia’s Neighborhoods from Azavea</a></li>
  <li><a href="#import-rcos-from-the-city" id="toc-import-rcos-from-the-city" class="nav-link" data-scroll-target="#import-rcos-from-the-city">Import RCOs from the City</a></li>
  <li><a href="#now-we-can-join-the-rcos-to-the-joined_gdf." id="toc-now-we-can-join-the-rcos-to-the-joined_gdf." class="nav-link" data-scroll-target="#now-we-can-join-the-rcos-to-the-joined_gdf.">Now we can join the RCOs to the joined_gdf.</a></li>
  <li><a href="#finally-tree-canopy-data." id="toc-finally-tree-canopy-data." class="nav-link" data-scroll-target="#finally-tree-canopy-data.">Finally, tree canopy data.</a></li>
  </ul></li>
  <li><a href="#gun-crimes" id="toc-gun-crimes" class="nav-link" data-scroll-target="#gun-crimes">Gun Crimes</a>
  <ul class="collapse">
  <li><a href="#import-gun-crime-data-from-the-citys-carto-database-sql" id="toc-import-gun-crime-data-from-the-citys-carto-database-sql" class="nav-link" data-scroll-target="#import-gun-crime-data-from-the-citys-carto-database-sql">1. Import gun crime data from the City’s Carto database (SQL):</a></li>
  <li><a href="#create-a-kernel-density-estimate-from-the-gun-crime-data" id="toc-create-a-kernel-density-estimate-from-the-gun-crime-data" class="nav-link" data-scroll-target="#create-a-kernel-density-estimate-from-the-gun-crime-data">2. Create a kernel density estimate from the gun crime data:</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<section id="imports" class="level1">
<h1>Imports</h1>
<p>First, we’ll import the necessary libraries.</p>
<div class="cell" data-pycharm="{&quot;is_executing&quot;:true}" data-execution_count="64">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Polygon</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> io</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zipfile</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.plot <span class="im">import</span> show</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.neighbors <span class="im">import</span> KernelDensity</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> collections</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># in response to an error importing collections, I used this: https://stackoverflow.com/questions/72032032/importerror-cannot-import-name-iterable-from-collections-in-python</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections.abc <span class="im">import</span> Iterable</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>collections.Iterable <span class="op">=</span> collections.abc.Iterable</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>collections.Mapping <span class="op">=</span> collections.abc.Mapping</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>collections.MutableSet <span class="op">=</span> collections.abc.MutableSet</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>collections.MutableMapping <span class="op">=</span> collections.abc.MutableMapping</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mapclassify</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we’ll query the City of Philadelphia data via the ArcGIS REST API using the <code>requests</code> library. We’ll also use the <code>json</code> library to parse the response.</p>
<p>Finally, we’ll use the <code>geopandas</code> library to create a geodataframe from the response.</p>
<p>We have three different datasets to import from the City’s ArcGIS server. These are:</p>
<section id="vacant-land" class="level3">
<h3 class="anchored" data-anchor-id="vacant-land">1. Vacant Land</h3>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the URL for the Vacant_Indicators_Land feature service</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>land_url <span class="op">=</span> <span class="st">'https://services.arcgis.com/fLeGjb7u4uXqeF9q/ArcGIS/rest/services/Vacant_Indicators_Land/FeatureServer/0/query'</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the parameters for the Vacant_Indicators_Land API request</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>land_params <span class="op">=</span> {</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'where'</span>: <span class="st">'1=1'</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'outFields'</span>: <span class="st">'*'</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'returnGeometry'</span>: <span class="st">'true'</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'f'</span>: <span class="st">'json'</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'resultRecordCount'</span>: <span class="dv">2000</span> <span class="co"># Number of features to return per request</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the Vacant_Indicators_Land API requests</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>land_dfs <span class="op">=</span> []</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>land_offset <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the offset parameter to the API request</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    land_params[<span class="st">'resultOffset'</span>] <span class="op">=</span> land_offset</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    land_response <span class="op">=</span> requests.get(land_url, params<span class="op">=</span>land_params)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> land_response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert the Vacant_Indicators_Land JSON data to a geopandas geodataframe; convert to CRS 3857</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        land_data <span class="op">=</span> land_response.json()</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># convert the JSON data to a pandas dataframe</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        land_df <span class="op">=</span> pd.DataFrame(land_data[<span class="st">'features'</span>])</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># separate the attributes column into one column per attribute</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>        land_df <span class="op">=</span> pd.concat([land_df.drop([<span class="st">'attributes'</span>], axis<span class="op">=</span><span class="dv">1</span>), land_df[<span class="st">'attributes'</span>].<span class="bu">apply</span>(pd.Series)], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># make the `geometry` column a shapely geometry object</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>        land_df[<span class="st">'geometry'</span>] <span class="op">=</span> land_df[<span class="st">'geometry'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: Polygon(x[<span class="st">'rings'</span>][<span class="dv">0</span>]))</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># convert the pandas dataframe to a geopandas geodataframe</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        land_gdf <span class="op">=</span> gpd.GeoDataFrame(land_df, geometry<span class="op">=</span><span class="st">'geometry'</span>, crs<span class="op">=</span><span class="st">'EPSG:3857'</span>)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        land_gdf.to_crs(epsg<span class="op">=</span><span class="dv">2272</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        land_dfs.append(land_gdf)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>        land_offset <span class="op">+=</span> <span class="bu">len</span>(land_gdf)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(land_gdf) <span class="op">&lt;</span> <span class="dv">2000</span>:</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span>  <span class="co"># If there are fewer than 2000 features returned, it means we have all the data</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Vacant_Indicators_Land Request failed with status code:'</span>, land_response.status_code)</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Concatenate the dataframes into a single geodataframe</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>land_gdf <span class="op">=</span> gpd.GeoDataFrame(pd.concat(land_dfs, ignore_index<span class="op">=</span><span class="va">True</span>), crs<span class="op">=</span><span class="st">'EPSG:2272'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>land_gdf.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<pre><code>(26276, 14)</code></pre>
</div>
</div>
</section>
<section id="vacant-buildings" class="level3">
<h3 class="anchored" data-anchor-id="vacant-buildings">2. Vacant Buildings</h3>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the URL for the Vacant_Indicators_Bldg feature service</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>bldg_url <span class="op">=</span> <span class="st">'https://services.arcgis.com/fLeGjb7u4uXqeF9q/ArcGIS/rest/services/Vacant_Indicators_Bldg/FeatureServer/0/query'</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the parameters for the Vacant_Indicators_Bldg API request</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>bldg_params <span class="op">=</span> {</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'where'</span>: <span class="st">'1=1'</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'outFields'</span>: <span class="st">'*'</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'returnGeometry'</span>: <span class="st">'true'</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'f'</span>: <span class="st">'json'</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'resultRecordCount'</span>: <span class="dv">2000</span> <span class="co"># Number of features to return per request</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the Vacant_Indicators_Bldg API requests</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>bldg_dfs <span class="op">=</span> []</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>bldg_offset <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the offset parameter to the API request</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    bldg_params[<span class="st">'resultOffset'</span>] <span class="op">=</span> bldg_offset</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    bldg_response <span class="op">=</span> requests.get(bldg_url, params<span class="op">=</span>bldg_params)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> bldg_response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert the Vacant_Indicators_bldg JSON data to a geopandas geodataframe; convert to CRS 3857</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        bldg_data <span class="op">=</span> bldg_response.json()</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># convert the JSON data to a pandas dataframe</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        bldg_df <span class="op">=</span> pd.DataFrame(bldg_data[<span class="st">'features'</span>])</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># separate the attributes column into one column per attribute</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        bldg_df <span class="op">=</span> pd.concat([bldg_df.drop([<span class="st">'attributes'</span>], axis<span class="op">=</span><span class="dv">1</span>), bldg_df[<span class="st">'attributes'</span>].<span class="bu">apply</span>(pd.Series)], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># make the `geometry` column a shapely geometry object</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        bldg_df[<span class="st">'geometry'</span>] <span class="op">=</span> bldg_df[<span class="st">'geometry'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: Polygon(x[<span class="st">'rings'</span>][<span class="dv">0</span>]))</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># convert the pandas dataframe to a geopandas geodataframe</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        bldg_gdf <span class="op">=</span> gpd.GeoDataFrame(bldg_df, geometry<span class="op">=</span><span class="st">'geometry'</span>, crs<span class="op">=</span><span class="st">'EPSG:3857'</span>)</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        bldg_gdf.to_crs(epsg<span class="op">=</span><span class="dv">2272</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        bldg_dfs.append(bldg_gdf)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        bldg_offset <span class="op">+=</span> <span class="bu">len</span>(bldg_gdf)</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(bldg_gdf) <span class="op">&lt;</span> <span class="dv">2000</span>:</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span>  <span class="co"># If there are fewer than 2000 features returned, it means we have all the data</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Vacant_Indicators_Bldg Request failed with status code:'</span>, bldg_response.status_code)</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Concatenate the dataframes into a single geodataframe</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>bldg_gdf <span class="op">=</span> gpd.GeoDataFrame(pd.concat(bldg_dfs, ignore_index<span class="op">=</span><span class="va">True</span>), crs<span class="op">=</span><span class="st">'EPSG:2272'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>bldg_gdf.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>(9722, 14)</code></pre>
</div>
</div>
</section>
<section id="now-combine-the-two-datasets-in-preparation-for-string-cleaning." class="level3">
<h3 class="anchored" data-anchor-id="now-combine-the-two-datasets-in-preparation-for-string-cleaning.">Now, combine the two datasets in preparation for string cleaning.</h3>
<div class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>columns <span class="op">=</span> [<span class="st">'geometry'</span>, <span class="st">'ADDRESS'</span>, <span class="st">'BLDG_DESC'</span>,</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>       <span class="st">'OPA_ID'</span>,<span class="st">'COUNCILDISTRICT'</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>       <span class="st">'ZIPCODE'</span>,<span class="st">'OWNER1'</span>, <span class="st">'OWNER2'</span>]</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># reduce gdfs to only the columns we want</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>land_gdf <span class="op">=</span> land_gdf[columns]</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>bldg_gdf <span class="op">=</span> bldg_gdf[columns]</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>land_gdf[<span class="st">'type'</span>] <span class="op">=</span> <span class="st">'Lot'</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>bldg_gdf[<span class="st">'type'</span>] <span class="op">=</span> <span class="st">'Building'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># bind the two geodataframes together using pandas.concat</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>full_gdf <span class="op">=</span> pd.concat([land_gdf, bldg_gdf], axis<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>full_gdf.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>geometry</th>
      <th>ADDRESS</th>
      <th>BLDG_DESC</th>
      <th>OPA_ID</th>
      <th>COUNCILDISTRICT</th>
      <th>ZIPCODE</th>
      <th>OWNER1</th>
      <th>OWNER2</th>
      <th>type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POLYGON ((2687288.180 256633.076, 2687182.041 ...</td>
      <td>3232 HENRY AVE</td>
      <td>COM.CONDO.1STY MASONRY</td>
      <td>882921188</td>
      <td>4</td>
      <td>19129</td>
      <td>NEWCOURTLAND ELDER SVCS</td>
      <td>None</td>
      <td>Lot</td>
    </tr>
    <tr>
      <th>1</th>
      <td>POLYGON ((2675580.787 242097.596, 2675611.032 ...</td>
      <td>633 N 53RD ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>442316810</td>
      <td>3</td>
      <td>19131</td>
      <td>REDEVELOPMENT AUTHORITY</td>
      <td>OF PHILADELPHIA</td>
      <td>Lot</td>
    </tr>
    <tr>
      <th>2</th>
      <td>POLYGON ((2694595.619 250002.049, 2694595.572 ...</td>
      <td>2424 N MOLE ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>161064101</td>
      <td>5</td>
      <td>19132</td>
      <td>REDEVELOPMENT AUTHORITY</td>
      <td>OF PHILADELPHIA</td>
      <td>Lot</td>
    </tr>
    <tr>
      <th>3</th>
      <td>POLYGON ((2699250.966 246745.116, 2699244.163 ...</td>
      <td>437 ARLINGTON ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>183194500</td>
      <td>7</td>
      <td>19122</td>
      <td>MCHUGH JOHN</td>
      <td>None</td>
      <td>Lot</td>
    </tr>
    <tr>
      <th>4</th>
      <td>POLYGON ((2695073.865 251698.897, 2695026.121 ...</td>
      <td>2735 N HICKS ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>111168200</td>
      <td>8</td>
      <td>19132</td>
      <td>HERBERT MITCHELL</td>
      <td>VICTORIA</td>
      <td>Lot</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</section>
<section id="now-well-apply-string-cleaning-to-the-owner1-and-owner2-columns-to-identify-public-vs.-private-ownership." class="level3">
<h3 class="anchored" data-anchor-id="now-well-apply-string-cleaning-to-the-owner1-and-owner2-columns-to-identify-public-vs.-private-ownership.">Now we’ll apply string cleaning to the OWNER1 and OWNER2 columns to identify public vs.&nbsp;private ownership.</h3>
<div class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>public_owners <span class="op">=</span> [<span class="st">'PHILADELPHIA LAND BANK'</span>,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILADELPHIA HOUSING AUTH'</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                <span class="st">'CITY OF PHILA'</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                <span class="st">'REDEVELOPMENT AUTHORITY OF PHILADELPHIA'</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                <span class="st">'CITY OF PHILADELPHIA'</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                <span class="st">'DEPT OF PUBLC PROP; CITY OF PHILA'</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                <span class="st">'DEPT OF PUBLIC PROP; CITY OF PHILA'</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                <span class="st">'DEPT PUB PROP; CITY OF PHILA'</span>,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                <span class="st">'REDEVELOPMENT AUTHORITY OF PHILA'</span>,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILA REDEVELOPMENT AUTH'</span>,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILADELPHIA LAND INVESTM'</span>,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                <span class="st">'REDEVELOPMENT AUTHORITY O'</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILADELPHIA REDEVELOPMEN'</span>,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILA HOUSING AUTHORITY'</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                <span class="st">'KENSINGTON HOUSING AUTHOR'</span>,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>                <span class="st">'DEVELOPMENT CORPORATION; PHILADELPHIA HOUSING'</span>,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILA REDEVELOPMENT AUTHO'</span>,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>                <span class="st">'DEPT OF PUB PROP; CITY OF PHILA'</span>,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILA HOUSING DEV CORP'</span>,</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>                <span class="st">'DEP OF PUB PROP; CITY OF PHILA'</span>,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>                <span class="st">'REDEVELOPMENT AUTHORITY'</span>,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">'COMMONWEALTH OF PA'</span>,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">'COMMONWEALTH OF PENNA'</span>,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">'DEPT OF PUBLIC PROP; CITY OF PHILADELPHIA'</span>,</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">'DEPT PUBLIC PROP R E DIV; CITY OF PHILA'</span>,</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PUBLIC PROP DIV; CITY OF PHILA'</span>,</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PUBLIC PROP REAL ESTATE; CITY OF PHILA'</span>,</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>                <span class="st">'REAL ESTATE DIV; CITY OF PHILA'</span>,</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">'REAL ESTATE DIVISION; CITY OF PHILA'</span>,</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>                <span class="st">'URBAN DEVELOPMENT; SECRETARY OF HOUSING'</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>                <span class="st">'URBAN DEVELOPMENT; SECRETARY OF HOUSING AND'</span>,</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILADELPHIA REDEVELOPMENT AUTHORITY'</span>,</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILADELPHIA REDEVELOPMENT AUTH'</span>,</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILADELPHIA HOUSING AUTHORITY'</span>,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILADELPHIA LAND BANK'</span>,</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>                <span class="st">'REDEVELOPMENT AUTHORITY OF PHILADELPHIA'</span>,</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILADELPHIA HOUSING AUTHORITY'</span>,</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">'CITY OF PHILADELPHIA'</span>,</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">'CITY OF PHILADELPHIA DEPARTMENT OF PUBLIC PROPERTY'</span>,</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>                <span class="st">'REDEVELOPMENT AUTHORITY OF PHILADELPHIA'</span>,</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILADELPHIA LAND INVESTMENT'</span>,</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILADELPHIA REDEVELOPMENT AUTHORITY'</span>,</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILADELPHIA HOUSING AUTHORITY'</span>,</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>                <span class="st">'KENSINGTON HOUSING AUTHORITY'</span>,</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILADELPHIA HOUSING DEVELOPMENT CORPORATION'</span>,</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>                <span class="st">'REDEVELOPMENT AUTHORITY OF PHILADELPHIA'</span>,</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>                <span class="st">'CITY OF PHILADELPHIA DEPARTMENT OF PUBLIC PROPERTY'</span>,</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILADELPHIA HOUSING DEVELOPMENT CORPORATION'</span>,</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>                <span class="st">'CITY OF PHILADELPHIA DEPARTMENT OF PUBLIC PROPERTY'</span>,</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>                <span class="st">'REDEVELOPMENT AUTHORITY OF PHILADELPHIA'</span>,</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>                <span class="st">'COMMONWEALTH OF PENNSYLVANIA'</span>,</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>                <span class="st">'CITY OF PHILADELPHIA DEPARTMENT OF PUBLIC PROPERTY'</span>,</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>                <span class="st">'SECRETARY OF HOUSING AND URBAN DEVELOPMENT'</span>,</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>                <span class="st">'REDEVELOPMENT AUTHORITY OF PHILADELPHIA'</span>,</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PHILADELPHIA LAND INVESTMENT'</span>,</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>                <span class="st">'CITY OF PHILADELPHIA DEPARTMENT OF PUBLIC PROPERTY'</span>,</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>                <span class="st">'PENNDOT'</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a><span class="co"># return unique public_owners</span></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>public_owners <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(public_owners))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new column that combines the OWNER1 and OWNER2 columns according to the following rules:</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># if OWNER1 is not null and OWNER2 is null, then the new column is OWNER1</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># if OWNER1 is null and OWNER2 is not null, then the new column is OWNER2</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># if OWNER2 starts with a preposition, then the new column is OWNER1 + OWNER2 separated by a space</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># if OWNER2 does not start with a preposition, then the new column is OWNER2 + OWNER1 separated by a se</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># define a function to check if a string starts with a preposition</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> starts_with_preposition(string):</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    prepositions <span class="op">=</span> [<span class="st">'a'</span>, <span class="st">'an'</span>, <span class="st">'and'</span>, <span class="st">'as'</span>, <span class="st">'at'</span>, <span class="st">'but'</span>, <span class="st">'by'</span>, <span class="st">'for'</span>, <span class="st">'from'</span>, <span class="st">'in'</span>, <span class="st">'into'</span>, <span class="st">'nor'</span>, <span class="st">'of'</span>, <span class="st">'on'</span>, <span class="st">'or'</span>, <span class="st">'so'</span>, <span class="st">'the'</span>, <span class="st">'to'</span>, <span class="st">'up'</span>, <span class="st">'yet'</span>]</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> string.split(<span class="st">' '</span>)[<span class="dv">0</span>].lower() <span class="kw">in</span> prepositions:</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co"># define a function to combine the OWNER1 and OWNER2 columns</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> combine_owners(row):</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pd.isnull(row[<span class="st">'OWNER1'</span>]) <span class="kw">and</span> pd.isnull(row[<span class="st">'OWNER2'</span>]):</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> pd.isnull(row[<span class="st">'OWNER1'</span>]) <span class="kw">and</span> <span class="kw">not</span> pd.isnull(row[<span class="st">'OWNER2'</span>]):</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> row[<span class="st">'OWNER2'</span>]</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="kw">not</span> pd.isnull(row[<span class="st">'OWNER1'</span>]) <span class="kw">and</span> pd.isnull(row[<span class="st">'OWNER2'</span>]):</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> row[<span class="st">'OWNER1'</span>]</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> starts_with_preposition(row[<span class="st">'OWNER2'</span>]):</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> row[<span class="st">'OWNER1'</span>] <span class="op">+</span> <span class="st">' '</span> <span class="op">+</span> row[<span class="st">'OWNER2'</span>]</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> row[<span class="st">'OWNER2'</span>] <span class="op">+</span> <span class="st">'; '</span> <span class="op">+</span> row[<span class="st">'OWNER1'</span>]</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="co"># apply the combine_owners function to the full_gdf dataframe</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>full_gdf[<span class="st">'OWNER'</span>] <span class="op">=</span> full_gdf.<span class="bu">apply</span>(combine_owners, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="co"># if OWNER is 'PHILADELPHIA HOUSING AUTH' or 'PHILA HOUSING AUTHORITY', replace with 'PHILADELPHIA HOUSING AUTHORITY'</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>full_gdf.loc[full_gdf[<span class="st">'OWNER'</span>] <span class="op">==</span> <span class="st">'PHILADELPHIA HOUSING AUTH'</span>, <span class="st">'OWNER'</span>] <span class="op">=</span> <span class="st">'PHILADELPHIA HOUSING AUTHORITY'</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>full_gdf.loc[full_gdf[<span class="st">'OWNER'</span>] <span class="op">==</span> <span class="st">'PHILA HOUSING AUTHORITY'</span>, <span class="st">'OWNER'</span>] <span class="op">=</span> <span class="st">'PHILADELPHIA HOUSING AUTHORITY'</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="co"># redevelopment authority typos</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>redev_owner_variations <span class="op">=</span> [<span class="st">'REDEVELOPMENT AUTHORITY OF PHILA'</span>, <span class="st">'PHILA REDEVELOPMENT AUTH'</span>,</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a><span class="st">'REDEVELOPMENT AUTHORITY O'</span>, <span class="st">'PHILADELPHIA REDEVELOPMEN'</span>,</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a><span class="st">'PHILA REDEVELOPMENT AUTHO'</span>, <span class="st">'REDEVELOPMENT AUTHORITY'</span>,</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span class="st">'REDEVELOPMENT AUTH'</span>]</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> var <span class="kw">in</span> redev_owner_variations:</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    full_gdf.loc[full_gdf[<span class="st">'OWNER'</span>] <span class="op">==</span> var, <span class="st">'OWNER'</span>] <span class="op">=</span> <span class="st">'REDEVELOPMENT AUTHORITY OF PHILADELPHIA'</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a><span class="co"># department of public property typos</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>dpp_owner_variations <span class="op">=</span> [<span class="st">'DEPT OF PUBLIC PROPERTY'</span>, <span class="st">'DEPT OF PUBLIC PROPERT'</span>, <span class="st">'DEPT OF PUBLC PROP; CITY OF PHILA'</span>,</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'DEPT OF PUBLIC PROP; CITY OF PHILA'</span>, <span class="st">'DEPT OF PUBLIC PROPERTY; CITY OF PHILA'</span>, <span class="st">'DEPT PUB PROP; CITY OF PHILA'</span>,</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'DEPT OF PUB PROP; CITY OF PHILA'</span>, <span class="st">'DEP OF PUB PROP; CITY OF PHILA'</span>, <span class="st">'DEPT OF PUBLIC PROP; CITY OF PHILADELPHIA'</span>,</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'DEPT PUBLIC PROP R E DIV; CITY OF PHILA'</span>, <span class="st">'PUBLIC PROP DIV; CITY OF PHILA'</span>, <span class="st">'PUBLIC PROP REAL ESTATE; CITY OF PHILA'</span>,</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'REAL ESTATE DIV; CITY OF PHILA'</span>, <span class="st">'REAL ESTATE DIVISION; CITY OF PHILA'</span>]</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> var <span class="kw">in</span> dpp_owner_variations:</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>    full_gdf.loc[full_gdf[<span class="st">'OWNER'</span>] <span class="op">==</span> var, <span class="st">'OWNER'</span>] <span class="op">=</span> <span class="st">'CITY OF PHILADELPHIA DEPARTMENT OF PUBLIC PROPERTY'</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a><span class="co"># HUD</span></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>full_gdf.loc[full_gdf[<span class="st">'OWNER'</span>] <span class="op">==</span> <span class="st">'URBAN DEVELOPMENT; SECRETARY OF HOUSING'</span>, <span class="st">'OWNER'</span>] <span class="op">=</span> <span class="st">'SECRETARY OF HOUSING AND URBAN DEVELOPMENT'</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>full_gdf.loc[full_gdf[<span class="st">'OWNER'</span>] <span class="op">==</span> <span class="st">'URBAN DEVELOPMENT; SECRETARY OF HOUSING AND'</span>, <span class="st">'OWNER'</span>] <span class="op">=</span> <span class="st">'SECRETARY OF HOUSING AND URBAN DEVELOPMENT'</span></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a><span class="co"># commonwealth of pennsylvania</span></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>full_gdf.loc[full_gdf[<span class="st">'OWNER'</span>] <span class="op">==</span> <span class="st">'COMMONWEALTH OF PA'</span>, <span class="st">'OWNER'</span>] <span class="op">=</span> <span class="st">'COMMONWEALTH OF PENNSYLVANIA'</span></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>full_gdf.loc[full_gdf[<span class="st">'OWNER'</span>] <span class="op">==</span> <span class="st">'COMMONWEALTH OF PENNA'</span>, <span class="st">'OWNER'</span>] <span class="op">=</span> <span class="st">'COMMONWEALTH OF PENNSYLVANIA'</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a><span class="co"># phdc</span></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>full_gdf.loc[full_gdf[<span class="st">'OWNER'</span>] <span class="op">==</span> <span class="st">'DEVELOPMENT CORPORATION; PHILADELPHIA HOUSING'</span>, <span class="st">'OWNER'</span>] <span class="op">=</span> <span class="st">'PHILADELPHIA HOUSING DEVELOPMENT CORPORATION'</span></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>full_gdf.loc[full_gdf[<span class="st">'OWNER'</span>] <span class="op">==</span> <span class="st">'PHILA HOUSING DEV CORP'</span>, <span class="st">'OWNER'</span>] <span class="op">=</span> <span class="st">'PHILADELPHIA HOUSING DEVELOPMENT CORPORATION'</span></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a><span class="co"># PennDOT</span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>full_gdf.loc[full_gdf[<span class="st">'OWNER'</span>] <span class="op">==</span> <span class="st">'DEPARTMENT OF TRANSPORTAT; COMMONWEALTH OF PENNSYLVA'</span>, <span class="st">'OWNER'</span>] <span class="op">=</span> <span class="st">'PENNDOT'</span></span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a><span class="co"># city of Philadelphia</span></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>full_gdf.loc[full_gdf[<span class="st">'OWNER'</span>] <span class="op">==</span> <span class="st">'CITY OF PHILADELPHIA'</span>, <span class="st">'OWNER'</span>] <span class="op">=</span> <span class="st">'CITY OF PHILA'</span></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new column called 'public_owner' that is True if the OWNER column is in the public_owners list</span></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>full_gdf[<span class="st">'public_owner'</span>] <span class="op">=</span> full_gdf[<span class="st">'OWNER'</span>].isin(public_owners)</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a><span class="co"># drop the OWNER1 and OWNER2 columns</span></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>full_gdf <span class="op">=</span> full_gdf.drop([<span class="st">'OWNER1'</span>, <span class="st">'OWNER2'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># randomly sample ten rows from the full_gdf dataframe</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>full_gdf.sample(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="74">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>geometry</th>
      <th>ADDRESS</th>
      <th>BLDG_DESC</th>
      <th>OPA_ID</th>
      <th>COUNCILDISTRICT</th>
      <th>ZIPCODE</th>
      <th>type</th>
      <th>OWNER</th>
      <th>public_owner</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>18052</th>
      <td>POLYGON ((2693106.146 249095.661, 2693103.774 ...</td>
      <td>2229 N 19TH ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>162071000</td>
      <td>5</td>
      <td>19132</td>
      <td>Lot</td>
      <td>ZALAZAR DAIANA YANET</td>
      <td>False</td>
    </tr>
    <tr>
      <th>10132</th>
      <td>POLYGON ((2700280.334 254460.781, 2700277.951 ...</td>
      <td>3335 N 5TH ST</td>
      <td>VAC LAND COMM. &lt; ACRE</td>
      <td>193128500</td>
      <td>7</td>
      <td>19140</td>
      <td>Lot</td>
      <td>MIKAYLA DEVELOPMENTS LLC</td>
      <td>False</td>
    </tr>
    <tr>
      <th>16394</th>
      <td>POLYGON ((2690289.242 268893.213, 2690235.576 ...</td>
      <td>5850 MORTON ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>591189000</td>
      <td>8</td>
      <td>19144</td>
      <td>Lot</td>
      <td>GIBBONS WAYNE L</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3143</th>
      <td>POLYGON ((2688076.800 250300.184, 2688074.916 ...</td>
      <td>2306 N 30TH ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>282075200</td>
      <td>5</td>
      <td>19132</td>
      <td>Lot</td>
      <td>PRIME MINISTER NORTH LLC</td>
      <td>False</td>
    </tr>
    <tr>
      <th>25400</th>
      <td>POLYGON ((2679069.891 245014.285, 2678877.560 ...</td>
      <td>4724-28 PARKSIDE AVE</td>
      <td>VAC LAND COMM. &lt; ACRE</td>
      <td>885595780</td>
      <td>4</td>
      <td>19131</td>
      <td>Lot</td>
      <td>C &amp; K ENTERPRISES CO LLC</td>
      <td>False</td>
    </tr>
    <tr>
      <th>8784</th>
      <td>POLYGON ((2695032.794 240371.855, 2695036.866 ...</td>
      <td>1208 LEMON ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>141279200</td>
      <td>5</td>
      <td>19123</td>
      <td>Lot</td>
      <td>KLZ PROPERTY LLC</td>
      <td>False</td>
    </tr>
    <tr>
      <th>7345</th>
      <td>POLYGON ((2700182.387 250263.232, 2700181.917 ...</td>
      <td>2613 N 4TH ST</td>
      <td>ROW 3 STY MASONRY</td>
      <td>192130100</td>
      <td>7</td>
      <td>19133</td>
      <td>Building</td>
      <td>MARRERO-RIOS LEWIS F</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4517</th>
      <td>POLYGON ((2696262.084 239266.301, 2696244.005 ...</td>
      <td>909 BUTTONWOOD ST</td>
      <td>PARKING LOT COMMERCIAL</td>
      <td>885052120</td>
      <td>1</td>
      <td>19123</td>
      <td>Lot</td>
      <td>CITY OF PHILA</td>
      <td>True</td>
    </tr>
    <tr>
      <th>13269</th>
      <td>POLYGON ((2694004.850 243414.457, 2694002.667 ...</td>
      <td>1218 N 15TH ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>471188510</td>
      <td>5</td>
      <td>19121</td>
      <td>Lot</td>
      <td>CITY OF PHILA</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1267</th>
      <td>POLYGON ((2700548.705 258183.000, 2700546.832 ...</td>
      <td>4009 N REESE ST</td>
      <td>ROW 2 STY MASONRY</td>
      <td>433042200</td>
      <td>7</td>
      <td>19140</td>
      <td>Building</td>
      <td>TOMLIN TORRI</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</section>
<section id="phs-community-landcare-parcels" class="level3">
<h3 class="anchored" data-anchor-id="phs-community-landcare-parcels">3. PHS Community Landcare Parcels</h3>
<p>Now we can import the PHS Community LandCare parcels and spatially join them to our full_gdf, which contains all of the vacant parcels in the city (both lots and buildings).</p>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the URL for the PHS_CommunityLandcare feature service</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>phs_landcare_url <span class="op">=</span> <span class="st">'https://services.arcgis.com/fLeGjb7u4uXqeF9q/ArcGIS/rest/services/PHS_CommunityLandcare/FeatureServer/0/query'</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the parameters for the PHS_CommunityLandcare API request</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>phs_landcare_params <span class="op">=</span> {</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'where'</span>: <span class="st">'1=1'</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'outFields'</span>: <span class="st">'*'</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'returnGeometry'</span>: <span class="st">'true'</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'f'</span>: <span class="st">'json'</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'resultRecordCount'</span>: <span class="dv">2000</span> <span class="co"># Number of features to return per request</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the PHS_CommunityLandcare API requests</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>phs_dfs <span class="op">=</span> []</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>phs_offset <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the offset parameter to the API request</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    phs_landcare_params[<span class="st">'resultOffset'</span>] <span class="op">=</span> phs_offset</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    phs_landcare_response <span class="op">=</span> requests.get(phs_landcare_url, params<span class="op">=</span>phs_landcare_params)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> phs_landcare_response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert the PHS_CommunityLandcare JSON data to a geopandas geodataframe; convert to CRS 3857</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        phs_landcare_data <span class="op">=</span> phs_landcare_response.json()</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># convert the JSON data to a pandas dataframe</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        phs_landcare_df <span class="op">=</span> pd.DataFrame(phs_landcare_data[<span class="st">'features'</span>])</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># separate the attributes column into one column per attribute</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        phs_landcare_df <span class="op">=</span> pd.concat([phs_landcare_df.drop([<span class="st">'attributes'</span>], axis<span class="op">=</span><span class="dv">1</span>), phs_landcare_df[<span class="st">'attributes'</span>].<span class="bu">apply</span>(pd.Series)], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># make the `geometry` column a shapely geometry object</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>        phs_landcare_df[<span class="st">'geometry'</span>] <span class="op">=</span> phs_landcare_df[<span class="st">'geometry'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: Polygon(x[<span class="st">'rings'</span>][<span class="dv">0</span>]))</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># convert the pandas dataframe to a geopandas geodataframe</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>        phs_landcare_gdf <span class="op">=</span> gpd.GeoDataFrame(phs_landcare_df, geometry<span class="op">=</span><span class="st">'geometry'</span>, crs<span class="op">=</span><span class="st">'EPSG:3857'</span>)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>        phs_landcare_gdf.to_crs(epsg<span class="op">=</span><span class="dv">2272</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>        phs_dfs.append(phs_landcare_gdf)</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>        phs_offset <span class="op">+=</span> <span class="bu">len</span>(phs_landcare_gdf)</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(phs_landcare_gdf) <span class="op">&lt;</span> <span class="dv">2000</span>:</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span>  <span class="co"># If there are fewer than 2000 features returned, it means we have all the data</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'PHS_CommunityLandcare Request failed with status code:'</span>, phs_landcare_response.status_code)</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Concatenate the dataframes into a single geodataframe</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>phs_landcare_gdf <span class="op">=</span> gpd.GeoDataFrame(pd.concat(phs_dfs, ignore_index<span class="op">=</span><span class="va">True</span>), crs<span class="op">=</span><span class="st">'EPSG:2272'</span>)</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>phs_cols <span class="op">=</span> [<span class="st">'geometry'</span>, <span class="st">'COMM_PARTN'</span>]</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>phs_landcare_gdf <span class="op">=</span> phs_landcare_gdf[phs_cols]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>phs_landcare_gdf.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="76">
<pre><code>(2263, 2)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># spatially join phs_landcare_gdf to full_gdf</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>joined_gdf <span class="op">=</span> gpd.sjoin(full_gdf, phs_landcare_gdf, how<span class="op">=</span><span class="st">'left'</span>, predicate<span class="op">=</span><span class="st">'intersects'</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># drop the index_right column and the ADDRESS_right column</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>joined_gdf <span class="op">=</span> joined_gdf.drop([<span class="st">'index_right'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>joined_gdf[<span class="st">'COMM_PARTN'</span>] <span class="op">=</span> joined_gdf[<span class="st">'COMM_PARTN'</span>].fillna(<span class="st">'None'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>joined_gdf.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="78">
<pre><code>Index(['geometry', 'ADDRESS', 'BLDG_DESC', 'OPA_ID', 'COUNCILDISTRICT',
       'ZIPCODE', 'type', 'OWNER', 'public_owner', 'COMM_PARTN'],
      dtype='object')</code></pre>
</div>
</div>
<p>Now we need to import two more datasets from the City’s Carto database (SQL).</p>
</section>
<section id="li-complaints" class="level3">
<h3 class="anchored" data-anchor-id="li-complaints">1. L&amp;I Complaints</h3>
<div class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate one year ago from today's date</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>one_year_ago <span class="op">=</span> (datetime.datetime.now() <span class="op">-</span> datetime.timedelta(days<span class="op">=</span><span class="dv">365</span>)).strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the SQL query</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>complaints_sql_query <span class="op">=</span> <span class="st">"SELECT address, service_request_id, subject, status, service_name, service_code, lat, lon FROM public_cases_fc WHERE requested_datetime &gt;= '</span><span class="sc">{}</span><span class="st">'"</span>.<span class="bu">format</span>(one_year_ago)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the GET request</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>complaints_response <span class="op">=</span> requests.get(<span class="st">"https://phl.carto.com/api/v2/sql"</span>, params<span class="op">=</span>{<span class="st">"q"</span>: complaints_sql_query})</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the data</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>complaints_data <span class="op">=</span> complaints_response.json()[<span class="st">"rows"</span>]</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co"># convert complaints_data to a pandas dataframe</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>complaints_df <span class="op">=</span> pd.DataFrame(complaints_data)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the data to a geopandas dataframe</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>complaints_gdf <span class="op">=</span> gpd.GeoDataFrame(complaints_df, geometry<span class="op">=</span>gpd.points_from_xy(complaints_df.lon, complaints_df.lat), crs<span class="op">=</span><span class="st">'EPSG:2272'</span>)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="co"># drop the lat and lon columns</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>complaints_gdf.drop([<span class="st">'lat'</span>, <span class="st">'lon'</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="co"># filter for only Status = 'Open'</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>complaints_gdf <span class="op">=</span> complaints_gdf[complaints_gdf[<span class="st">'status'</span>] <span class="op">==</span> <span class="st">'Open'</span>]</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="co"># collapse complaints_gdf by address and concatenate the violationcodetitle values into a list with a semicolon separator</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>complaints_gdf <span class="op">=</span> complaints_gdf.groupby(<span class="st">'address'</span>)[<span class="st">'service_name'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="st">'; '</span>.join([val <span class="cf">for</span> val <span class="kw">in</span> x <span class="cf">if</span> val <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>])).reset_index()</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="co"># rename the column to 'li_complaints'</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>complaints_gdf.rename(columns<span class="op">=</span>{<span class="st">'service_name'</span>: <span class="st">'li_complaints'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>complaints_gdf.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="80">
<pre><code>(45241, 2)</code></pre>
</div>
</div>
</section>
<section id="li-code-violations" class="level3">
<h3 class="anchored" data-anchor-id="li-code-violations">2. L&amp;I Code Violations</h3>
<div class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate one year ago from today's date</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>one_year_ago <span class="op">=</span> (datetime.datetime.now() <span class="op">-</span> datetime.timedelta(days<span class="op">=</span><span class="dv">365</span>)).strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the SQL query</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>violations_sql_query <span class="op">=</span> <span class="st">"SELECT parcel_id_num, casenumber, casecreateddate, casetype, casestatus, violationnumber, violationcodetitle, violationstatus, opa_account_num, address, opa_owner, geocode_x, geocode_y FROM violations WHERE violationdate &gt;= '</span><span class="sc">{}</span><span class="st">'"</span>.<span class="bu">format</span>(one_year_ago)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the GET request</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>violations_response <span class="op">=</span> requests.get(<span class="st">"https://phl.carto.com/api/v2/sql"</span>, params<span class="op">=</span>{<span class="st">"q"</span>: violations_sql_query})</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the data</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>violations_data <span class="op">=</span> violations_response.json()[<span class="st">"rows"</span>]</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co"># convert violations_data to a pandas dataframe</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>violations_df <span class="op">=</span> pd.DataFrame(violations_data)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the data to a geopandas dataframe</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>violations_gdf <span class="op">=</span> gpd.GeoDataFrame(violations_df, geometry<span class="op">=</span>gpd.points_from_xy(violations_df.geocode_x, violations_df.geocode_y), crs<span class="op">=</span><span class="st">'EPSG:2272'</span>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="co"># drop the lat and lon columns</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>violations_gdf.drop([<span class="st">'geocode_x'</span>, <span class="st">'geocode_y'</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="co"># filter for only cases where the casestatus is 'IN VIOLATION' or 'UNDER INVESTIGATION'</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>violations_gdf <span class="op">=</span> violations_gdf[(violations_gdf[<span class="st">'violationstatus'</span>] <span class="op">==</span> <span class="st">'OPEN'</span>)]</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="co"># collapse violations_gdf by address and concatenate the violationcodetitle values into a list with a semicolon separator</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>violations_gdf <span class="op">=</span> violations_gdf.groupby(<span class="st">'opa_account_num'</span>)[<span class="st">'violationcodetitle'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="st">'; '</span>.join([val <span class="cf">for</span> val <span class="kw">in</span> x <span class="cf">if</span> val <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>])).reset_index()</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="co"># rename the column to 'li_violations'</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>violations_gdf.rename(columns<span class="op">=</span>{<span class="st">'violationcodetitle'</span>: <span class="st">'li_code_violations'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>violations_gdf.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>(11190, 2)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># left join the complaints_gdf to the joined_gdf on address</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>joined_gdf <span class="op">=</span> joined_gdf.merge(complaints_gdf, how<span class="op">=</span><span class="st">'left'</span>, left_on<span class="op">=</span><span class="st">'ADDRESS'</span>, right_on<span class="op">=</span><span class="st">'address'</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># left join the violations_gdf to the joined_gdf on opa_account_num</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>joined_gdf <span class="op">=</span> joined_gdf.merge(violations_gdf, how<span class="op">=</span><span class="st">'left'</span>, left_on<span class="op">=</span><span class="st">'OPA_ID'</span>, right_on<span class="op">=</span><span class="st">'opa_account_num'</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co"># drop the address and opa_account_num columns</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>joined_gdf.drop([<span class="st">'address'</span>, <span class="st">'opa_account_num'</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="next-well-add-a-centroids-column-to-the-joined_gdf-in-order-to-make-it-easier-to-cleanly-join-neighborhoods-rcos-tree-canopy-and-guncrime-data." class="level3">
<h3 class="anchored" data-anchor-id="next-well-add-a-centroids-column-to-the-joined_gdf-in-order-to-make-it-easier-to-cleanly-join-neighborhoods-rcos-tree-canopy-and-guncrime-data.">Next, we’ll add a centroids column to the joined_gdf in order to make it easier to cleanly join neighborhoods, RCOs, tree canopy, and guncrime data.</h3>
<p>Joining by points rather than polygons makes it far less likely that a point straddles two polygons, which make the join ambiguous and potentially incorrect.</p>
<div class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add a column for centroids geometry to use for joins and to extrct raster values</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>joined_gdf[<span class="st">'centroid'</span>] <span class="op">=</span> joined_gdf[<span class="st">'geometry'</span>].centroid</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create a geodata of polygon geoms and opa_id</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>poly_gdf <span class="op">=</span> joined_gdf[[<span class="st">'OPA_ID'</span>, <span class="st">'geometry'</span>]]</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># drop the 'geometry' column from joined_gdf</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>joined_gdf.drop([<span class="st">'geometry'</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co"># set the 'centroid' column as the geometry column</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>joined_gdf.set_geometry(<span class="st">'centroid'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="import-philadelphias-neighborhoods-from-azavea" class="level3">
<h3 class="anchored" data-anchor-id="import-philadelphias-neighborhoods-from-azavea">Import Philadelphia’s Neighborhoods from Azavea</h3>
<div class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>hoods_url <span class="op">=</span> <span class="st">'https://github.com/azavea/geo-data/raw/master/Neighborhoods_Philadelphia/Neighborhoods_Philadelphia.zip'</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>hoods_response <span class="op">=</span> requests.get(hoods_url)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> io.BytesIO(hoods_response.content) <span class="im">as</span> f:</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> zipfile.ZipFile(f, <span class="st">'r'</span>) <span class="im">as</span> zip_ref:</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>        zip_ref.extractall(<span class="st">"path/to/destination/folder"</span>)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>hoods <span class="op">=</span> gpd.read_file(<span class="st">"path/to/destination/folder/Neighborhoods_Philadelphia.shp"</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>hoods <span class="op">=</span> hoods.to_crs(epsg<span class="op">=</span><span class="dv">2272</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>joined_gdf <span class="op">=</span> gpd.sjoin(joined_gdf, hoods, how<span class="op">=</span><span class="st">'left'</span>, predicate<span class="op">=</span><span class="st">'intersects'</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>joined_gdf <span class="op">=</span> joined_gdf.drop([<span class="st">'index_right'</span>, <span class="st">'NAME'</span>, <span class="st">'LISTNAME'</span>, <span class="st">'Shape_Leng'</span>, <span class="st">'Shape_Area'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>joined_gdf.rename(columns<span class="op">=</span>{<span class="st">'MAPNAME'</span>: <span class="st">'neighborhood'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="import-rcos-from-the-city" class="level3">
<h3 class="anchored" data-anchor-id="import-rcos-from-the-city">Import RCOs from the City</h3>
<div class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the URL for the RCOs feature service</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>rcos_url <span class="op">=</span> <span class="st">'https://services.arcgis.com/fLeGjb7u4uXqeF9q/ArcGIS/rest/services/Zoning_RCO/FeatureServer/0/query'</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the parameters for the RCOs API request</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>rcos_params <span class="op">=</span> {</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'where'</span>: <span class="st">'1=1'</span>,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'outFields'</span>: <span class="st">'*'</span>,</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'returnGeometry'</span>: <span class="st">'true'</span>,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'f'</span>: <span class="st">'json'</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the RCOs API request</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>rcos_response <span class="op">=</span> requests.get(rcos_url, params<span class="op">=</span>rcos_params)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if the RCOs request was successful</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> rcos_response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the RCOs JSON data to a geopandas geodataframe; convert to CRS 3857</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    rcos_data <span class="op">=</span> rcos_response.json()</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert the JSON data to a pandas dataframe</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    rcos_df <span class="op">=</span> pd.DataFrame(rcos_data[<span class="st">'features'</span>])</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># separate the attributes column into one column per attribute</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>    rcos_df <span class="op">=</span> pd.concat([rcos_df.drop([<span class="st">'attributes'</span>], axis<span class="op">=</span><span class="dv">1</span>), rcos_df[<span class="st">'attributes'</span>].<span class="bu">apply</span>(pd.Series)], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'RCOs Request failed with status code:'</span>, rcos_response.status_code)</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a><span class="co"># make the `geometry` column a shapely geometry object</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>rcos_df[<span class="st">'geometry'</span>] <span class="op">=</span> rcos_df[<span class="st">'geometry'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: Polygon(x[<span class="st">'rings'</span>][<span class="dv">0</span>]))</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a> <span class="co"># convert the pandas dataframe to a geopandas geodataframe</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>rcos_gdf <span class="op">=</span> gpd.GeoDataFrame(rcos_df, geometry<span class="op">=</span><span class="st">'geometry'</span>, crs<span class="op">=</span><span class="st">'EPSG:3857'</span>)</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>rcos_gdf.to_crs(epsg<span class="op">=</span><span class="dv">2272</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>rcos_cols <span class="op">=</span> [<span class="st">'geometry'</span>, <span class="st">'ORGANIZATION_NAME'</span>, <span class="st">'ORGANIZATION_ADDRESS'</span>,</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>       <span class="st">'ORG_TYPE'</span>, <span class="st">'PREFFERED_CONTACT_METHOD'</span>,</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>       <span class="st">'PRIMARY_NAME'</span>, <span class="st">'PRIMARY_ADDRESS'</span>, <span class="st">'PRIMARY_EMAIL'</span>, <span class="st">'PRIMARY_PHONE'</span>,</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>       <span class="st">'EXPIRATIONYEAR'</span>]</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a><span class="co"># convert primary_phone and expirationyear to strings</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>rcos_gdf[<span class="st">'PRIMARY_PHONE'</span>] <span class="op">=</span> rcos_gdf[<span class="st">'PRIMARY_PHONE'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>rcos_gdf[<span class="st">'EXPIRATIONYEAR'</span>] <span class="op">=</span> rcos_gdf[<span class="st">'EXPIRATIONYEAR'</span>].astype(<span class="bu">str</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>rco_aggregate_cols <span class="op">=</span> [<span class="st">'ORGANIZATION_NAME'</span>, <span class="st">'ORGANIZATION_ADDRESS'</span>, <span class="st">'PRIMARY_EMAIL'</span>, <span class="st">'PRIMARY_PHONE'</span>]</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>rcos_gdf[<span class="st">"rco_info"</span>] <span class="op">=</span> rcos_gdf[rco_aggregate_cols].agg(<span class="st">"; "</span>.join, axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>rcos_final_cols <span class="op">=</span> [<span class="st">'geometry'</span>, <span class="st">'rco_info'</span>]</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>rcos_gdf <span class="op">=</span> rcos_gdf[rcos_final_cols]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="now-we-can-join-the-rcos-to-the-joined_gdf." class="level3">
<h3 class="anchored" data-anchor-id="now-we-can-join-the-rcos-to-the-joined_gdf.">Now we can join the RCOs to the joined_gdf.</h3>
<div class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># spatially join rcos_gdf to joined_gdf</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>w_rcos_gdf <span class="op">=</span> gpd.sjoin(joined_gdf, rcos_gdf, how<span class="op">=</span><span class="st">'left'</span>, predicate<span class="op">=</span><span class="st">'within'</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># drop the index_right column</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>w_rcos_gdf <span class="op">=</span> w_rcos_gdf.drop([<span class="st">'index_right'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co"># change MAPNAME to neighborhood</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>w_rcos_gdf.rename(columns<span class="op">=</span>{<span class="st">'rco_info'</span>: <span class="st">'rco_info'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co"># remove duplicates by OPA_ID</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>w_rcos_gdf <span class="op">=</span> w_rcos_gdf.drop_duplicates(subset<span class="op">=</span><span class="st">'OPA_ID'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot w_rcos_gdf</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>w_rcos_gdf.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>(35850, 14)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make OPA_ID a string</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>w_rcos_gdf[<span class="st">'OPA_ID'</span>] <span class="op">=</span> w_rcos_gdf[<span class="st">'OPA_ID'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># collapse w_rcos_gdf by opa_id and concatenate the rco_info values into a list with a | separator</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>rcos_by_opa_id_gdf <span class="op">=</span> w_rcos_gdf.groupby(<span class="st">'OPA_ID'</span>)[<span class="st">'rco_info'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="st">'| '</span>.join([<span class="bu">str</span>(val) <span class="cf">for</span> val <span class="kw">in</span> x <span class="cf">if</span> val <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>])).reset_index()</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co"># rename the column to 'relevant_rcos'</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>rcos_by_opa_id_gdf.rename(columns<span class="op">=</span>{<span class="st">'rco_info'</span>: <span class="st">'relevant_rcos'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>rcos_by_opa_id_gdf.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>(35850, 2)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># left join the rcos_by_opa_id_gdf to the joined_gdf on opa_id</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>joined_gdf <span class="op">=</span> joined_gdf.merge(rcos_by_opa_id_gdf, how<span class="op">=</span><span class="st">'left'</span>, left_on<span class="op">=</span><span class="st">'OPA_ID'</span>, right_on<span class="op">=</span><span class="st">'OPA_ID'</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># drop duplicate rows</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>joined_gdf <span class="op">=</span> joined_gdf.drop_duplicates(subset<span class="op">=</span><span class="st">'OPA_ID'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>joined_gdf.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="95">
<pre><code>(35850, 14)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>joined_gdf.sample(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="96">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>ADDRESS</th>
      <th>BLDG_DESC</th>
      <th>OPA_ID</th>
      <th>COUNCILDISTRICT</th>
      <th>ZIPCODE</th>
      <th>type</th>
      <th>OWNER</th>
      <th>public_owner</th>
      <th>COMM_PARTN</th>
      <th>li_complaints</th>
      <th>li_code_violations</th>
      <th>centroid</th>
      <th>neighborhood</th>
      <th>relevant_rcos</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>23581</th>
      <td>1220 W DAUPHIN ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>371328101</td>
      <td>5</td>
      <td>19133</td>
      <td>Lot</td>
      <td>REDEVELOPMENT AUTHORITY OF PHILADELPHIA</td>
      <td>True</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>POINT (2696141.397 248938.784)</td>
      <td>Hartranft</td>
      <td>Asociacion Puertorriquenos En Marcha (APM); 60...</td>
    </tr>
    <tr>
      <th>12001</th>
      <td>1638 S BAILEY ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>364277500</td>
      <td>2</td>
      <td>19145</td>
      <td>Lot</td>
      <td>BATTAGLINI GINA</td>
      <td>False</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>POINT (2686602.937 228613.833)</td>
      <td>Grays Ferry</td>
      <td>Grays Ferry Community Council; 1501 s. 29th St...</td>
    </tr>
    <tr>
      <th>25517</th>
      <td>1008 W VENANGO ST</td>
      <td>VAC LAND COMM. &lt; ACRE</td>
      <td>885509160</td>
      <td>5</td>
      <td>19140</td>
      <td>Lot</td>
      <td>CATIC INC</td>
      <td>False</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>POINT (2698166.073 255934.534)</td>
      <td>Franklinville</td>
      <td>Nicetown-Tioga Improvement Team; 3621 N 11th S...</td>
    </tr>
    <tr>
      <th>7727</th>
      <td>3510 N 11TH ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>432138600</td>
      <td>5</td>
      <td>19140</td>
      <td>Lot</td>
      <td>COOK CHRISTINE; FENDERSON BERNARD</td>
      <td>False</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>POINT (2697655.664 255734.882)</td>
      <td>Franklinville</td>
      <td>Nicetown-Tioga Improvement Team; 3621 N 11th S...</td>
    </tr>
    <tr>
      <th>25135</th>
      <td>2430 N BODINE ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>191167518</td>
      <td>7</td>
      <td>19133</td>
      <td>Lot</td>
      <td>RIDGEWOOD GLOBAL INVESTMENT LLC</td>
      <td>False</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>POINT (2700362.817 249249.250)</td>
      <td>West Kensington</td>
      <td>Zulu Nation RCO; 2045 N Lawrence Street\r\nPhi...</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</section>
<section id="finally-tree-canopy-data." class="level3">
<h3 class="anchored" data-anchor-id="finally-tree-canopy-data.">Finally, tree canopy data.</h3>
<div class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>tree_url <span class="op">=</span> <span class="st">'https://national-tes-data-share.s3.amazonaws.com/national_tes_share/pa.zip.zip'</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>tree_response <span class="op">=</span> requests.get(tree_url)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> io.BytesIO(tree_response.content) <span class="im">as</span> f:</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> zipfile.ZipFile(f, <span class="st">'r'</span>) <span class="im">as</span> zip_ref:</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        zip_ref.extractall(<span class="st">"path/to/destination/folder"</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>pa <span class="op">=</span> gpd.read_file(<span class="st">"path/to/destination/folder/pa.shp"</span>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>pa <span class="op">=</span> pa.to_crs(epsg<span class="op">=</span><span class="dv">2272</span>)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>phl <span class="op">=</span> pa[pa[<span class="st">'county'</span>] <span class="op">==</span> <span class="st">'Philadelphia County'</span>]</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>tree_cols <span class="op">=</span> [<span class="st">'tc_gap'</span>, <span class="st">'geometry'</span>]</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>phl <span class="op">=</span> phl[tree_cols]</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>phl.rename(columns<span class="op">=</span>{<span class="st">'tc_gap'</span>: <span class="st">'tree_canopy_gap'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>phl.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="97">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>tree_canopy_gap</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5395</th>
      <td>0.216832</td>
      <td>POLYGON ((2698038.313 234970.868, 2697586.173 ...</td>
    </tr>
    <tr>
      <th>5396</th>
      <td>0.196093</td>
      <td>POLYGON ((2699640.691 237442.051, 2699638.100 ...</td>
    </tr>
    <tr>
      <th>5397</th>
      <td>0.297005</td>
      <td>POLYGON ((2696855.043 237339.498, 2696827.290 ...</td>
    </tr>
    <tr>
      <th>5398</th>
      <td>0.346134</td>
      <td>POLYGON ((2693798.320 238055.129, 2693725.464 ...</td>
    </tr>
    <tr>
      <th>5399</th>
      <td>0.097603</td>
      <td>POLYGON ((2689575.081 237146.348, 2689561.703 ...</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># spatially join phl to joined_gdf</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>joined_gdf <span class="op">=</span> gpd.sjoin(joined_gdf, phl, how<span class="op">=</span><span class="st">'left'</span>, predicate<span class="op">=</span><span class="st">'intersects'</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>joined_gdf <span class="op">=</span> joined_gdf.drop([<span class="st">'index_right'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co"># drop duplicate opa_ids</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>joined_gdf <span class="op">=</span> joined_gdf.drop_duplicates(subset<span class="op">=</span><span class="st">'OPA_ID'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>joined_gdf.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="99">
<pre><code>(35850, 15)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="100">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>joined_gdf.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="100">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>ADDRESS</th>
      <th>BLDG_DESC</th>
      <th>OPA_ID</th>
      <th>COUNCILDISTRICT</th>
      <th>ZIPCODE</th>
      <th>type</th>
      <th>OWNER</th>
      <th>public_owner</th>
      <th>COMM_PARTN</th>
      <th>li_complaints</th>
      <th>li_code_violations</th>
      <th>centroid</th>
      <th>neighborhood</th>
      <th>relevant_rcos</th>
      <th>tree_canopy_gap</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3232 HENRY AVE</td>
      <td>COM.CONDO.1STY MASONRY</td>
      <td>882921188</td>
      <td>4</td>
      <td>19129</td>
      <td>Lot</td>
      <td>NEWCOURTLAND ELDER SVCS</td>
      <td>False</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>POINT (2687670.347 256881.319)</td>
      <td>Allegheny West</td>
      <td>East Falls Community Council; PO Box 12672, 19...</td>
      <td>0.230223</td>
    </tr>
    <tr>
      <th>1</th>
      <td>633 N 53RD ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>442316810</td>
      <td>3</td>
      <td>19131</td>
      <td>Lot</td>
      <td>REDEVELOPMENT AUTHORITY OF PHILADELPHIA</td>
      <td>True</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>POINT (2675594.486 242078.492)</td>
      <td>Haddington</td>
      <td>Parkside Association; Parkside Evans Recreatio...</td>
      <td>0.104381</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2424 N MOLE ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>161064101</td>
      <td>5</td>
      <td>19132</td>
      <td>Lot</td>
      <td>REDEVELOPMENT AUTHORITY OF PHILADELPHIA</td>
      <td>True</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>POINT (2694579.519 249996.821)</td>
      <td>Stanton</td>
      <td>Uptown Entertainment and Development Corporati...</td>
      <td>0.165151</td>
    </tr>
    <tr>
      <th>3</th>
      <td>437 ARLINGTON ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>183194500</td>
      <td>7</td>
      <td>19122</td>
      <td>Lot</td>
      <td>MCHUGH JOHN</td>
      <td>False</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>POINT (2699241.653 246723.548)</td>
      <td>West Kensington</td>
      <td>Zulu Nation RCO; 2045 N Lawrence Street\r\nPhi...</td>
      <td>0.199069</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2735 N HICKS ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>111168200</td>
      <td>8</td>
      <td>19132</td>
      <td>Lot</td>
      <td>VICTORIA; HERBERT MITCHELL</td>
      <td>False</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>POINT (2695050.897 251708.887)</td>
      <td>Stanton</td>
      <td>Tioga United, Inc.; 1539 W. Venango Street \r\...</td>
      <td>0.327281</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the joined_gdf</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>joined_gdf.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="101">
<pre><code>&lt;AxesSubplot: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023_02_02_vacant_lots_layer_files/figure-html/cell-39-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="gun-crimes" class="level1">
<h1>Gun Crimes</h1>
<p>For our gun crime kernel density estimate, we have two steps:</p>
<section id="import-gun-crime-data-from-the-citys-carto-database-sql" class="level3">
<h3 class="anchored" data-anchor-id="import-gun-crime-data-from-the-citys-carto-database-sql">1. Import gun crime data from the City’s Carto database (SQL):</h3>
<div class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Modify the SQL query</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>guncrime_sql_query <span class="op">=</span> <span class="st">"SELECT text_general_code, dispatch_date, point_x, point_y FROM incidents_part1_part2 WHERE dispatch_date_time &gt;= '</span><span class="sc">{}</span><span class="st">' AND text_general_code IN ('Aggravated Assault Firearm', 'Robbery Firearm')"</span>.<span class="bu">format</span>(one_year_ago)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the GET request</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>guncrime_response <span class="op">=</span> requests.get(<span class="st">"https://phl.carto.com/api/v2/sql"</span>, params<span class="op">=</span>{<span class="st">"q"</span>: guncrime_sql_query})</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the data</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>guncrime_data <span class="op">=</span> guncrime_response.json()[<span class="st">"rows"</span>]</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="co"># convert guncrime_data to a pandas dataframe</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>guncrime_df <span class="op">=</span> pd.DataFrame(guncrime_data)</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the data to a geopandas dataframe</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>guncrime_gdf <span class="op">=</span> gpd.GeoDataFrame(guncrime_df, geometry<span class="op">=</span>gpd.points_from_xy(guncrime_df.point_x, guncrime_df.point_y), crs<span class="op">=</span><span class="st">'EPSG:4326'</span>)</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="co"># drop the lat and lon columns</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>guncrime_gdf.drop([<span class="st">'point_x'</span>, <span class="st">'point_y'</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a><span class="co"># convert the geometry column to a CRS 2272</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>guncrime_gdf.to_crs(epsg<span class="op">=</span><span class="dv">2272</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a><span class="co"># drop null geometry values</span></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>guncrime_gdf <span class="op">=</span> guncrime_gdf[guncrime_gdf[<span class="st">'geometry'</span>].notnull()]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>c:\Users\Nissim\.conda\envs\vac_props_guncrime_dash\Lib\site-packages\geopandas\geoseries.py:751: UserWarning: GeoSeries.notna() previously returned False for both missing (None) and empty geometries. Now, it only returns False for missing values. Since the calling GeoSeries contains empty geometries, the result has changed compared to previous versions of GeoPandas.
Given a GeoSeries 's', you can use '~s.is_empty &amp; s.notna()' to get back the old behaviour.

To further ignore this warning, you can do: 
import warnings; warnings.filterwarnings('ignore', 'GeoSeries.notna', UserWarning)
  return self.notna()</code></pre>
</div>
</div>
<div class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>guncrime_gdf.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="103">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>text_general_code</th>
      <th>dispatch_date</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Robbery Firearm</td>
      <td>2022-09-11</td>
      <td>POINT (2697059.540 255757.300)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Aggravated Assault Firearm</td>
      <td>2022-10-11</td>
      <td>POINT (2674606.387 241816.289)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Robbery Firearm</td>
      <td>2022-08-24</td>
      <td>POINT (2707412.090 249356.412)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Robbery Firearm</td>
      <td>2022-10-02</td>
      <td>POINT (2702434.816 265367.796)</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Robbery Firearm</td>
      <td>2022-08-19</td>
      <td>POINT (2726676.221 264105.934)</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>guncrime_gdf.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>(6523, 3)</code></pre>
</div>
</div>
</section>
<section id="create-a-kernel-density-estimate-from-the-gun-crime-data" class="level3">
<h3 class="anchored" data-anchor-id="create-a-kernel-density-estimate-from-the-gun-crime-data">2. Create a kernel density estimate from the gun crime data:</h3>
<p>Note that, rather than following the one mile bandwidth used in the original research, I’m using an adaptive bandwidth based on Silverman’s rule to account for varying local densities. Silverman’s is more robust than Scott’s method as well. I’m implementing this in scipy’s gaussian_kde function.</p>
<p>, B., 1986. Density estimation for statistic and data analysis. London, UK: Chapman and Hall. https://ned.ipac.caltech.edu/level5/March02/Silverman/paper.pdf.</p>
<p>Note that ArcGIS Pro implements Silverman’s Rule of Thumb: https://pro.arcgis.com/en/pro-app/latest/tool-reference/spatial-analyst/how-kernel-density-works.htm</p>
<p>However, I really need to look into this more to make sure that I’ve implemented it correctly. The distribution of my data is non-parametric, meaning that neither Scott’s nor Silverman’s methods are appropriate.</p>
<div class="cell" data-execution_count="105">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> gaussian_kde</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get X and Y coordinates of well points</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>x_sk <span class="op">=</span> guncrime_gdf[<span class="st">"geometry"</span>].x</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>y_sk <span class="op">=</span> guncrime_gdf[<span class="st">"geometry"</span>].y</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="co"># drop null values</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>x_sk <span class="op">=</span> x_sk.dropna()</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>y_sk <span class="op">=</span> y_sk.dropna()</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Get minimum and maximum coordinate values of well points</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>min_x_sk, min_y_sk, max_x_sk, max_y_sk <span class="op">=</span> guncrime_gdf.total_bounds</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a cell mesh grid</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Horizontal and vertical cell counts should be the same</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>XX_sk, YY_sk <span class="op">=</span> np.mgrid[min_x_sk:max_x_sk:<span class="ot">100j</span>, min_y_sk:max_y_sk:<span class="ot">100j</span>]</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Create 2-D array of the coordinates (paired) of each cell in the mesh grid</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>positions_sk <span class="op">=</span> np.vstack([XX_sk.ravel(), YY_sk.ravel()])</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create 2-D array of the coordinate values of the well points</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>Xtrain_sk <span class="op">=</span> np.vstack([x_sk, y_sk])</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate the bandwidth using Silverman's rule, which is more robust than Scott's</span></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>kde_sk <span class="op">=</span> gaussian_kde(Xtrain_sk, bw_method<span class="op">=</span><span class="st">'silverman'</span>)</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate the estimator on coordinate pairs</span></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>Z_sk <span class="op">=</span> kde_sk(positions_sk)</span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to fit mesh grid</span></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>Z_sk <span class="op">=</span> Z_sk.reshape(XX_sk.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(Z_sk.ravel())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="106">
<pre><code>&lt;AxesSubplot: ylabel='Density'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023_02_02_vacant_lots_layer_files/figure-html/cell-44-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot Z_sk</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>plt.imshow(np.rot90(Z_sk), cmap<span class="op">=</span>plt.cm.gist_earth_r, extent<span class="op">=</span>[min_x_sk, max_x_sk, min_y_sk, max_y_sk])</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>plt.plot(x_sk, y_sk, <span class="st">'k.'</span>, markersize<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Estimated density of gun crimes in Philadelphia'</span>)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023_02_02_vacant_lots_layer_files/figure-html/cell-45-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>today <span class="op">=</span> datetime.datetime.today().strftime(<span class="st">'%Y_%m_</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> export_kde_raster(Z, XX, YY, min_x, max_x, min_y, max_y, proj, filename):</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Export and save a kernel density raster.'''</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Flip array vertically and rotate 270 degrees</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    Z_export <span class="op">=</span> np.rot90(np.flip(Z, <span class="dv">0</span>), <span class="dv">3</span>)</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get resolution</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    xres <span class="op">=</span> (max_x <span class="op">-</span> min_x) <span class="op">/</span> <span class="bu">len</span>(XX)</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    yres <span class="op">=</span> (max_y <span class="op">-</span> min_y) <span class="op">/</span> <span class="bu">len</span>(YY)</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set transform</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>    transform <span class="op">=</span> rasterio.Affine.translation(min_x <span class="op">-</span> xres <span class="op">/</span> <span class="dv">2</span>, min_y <span class="op">-</span> yres <span class="op">/</span> <span class="dv">2</span>) <span class="op">*</span> rasterio.Affine.scale(xres, yres)</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Export array as raster</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> rasterio.<span class="bu">open</span>(</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>            filename,</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>            mode <span class="op">=</span> <span class="st">"w"</span>,</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>            driver <span class="op">=</span> <span class="st">"GTiff"</span>,</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>            height <span class="op">=</span> Z_export.shape[<span class="dv">0</span>],</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>            width <span class="op">=</span> Z_export.shape[<span class="dv">1</span>],</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>            count <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>            dtype <span class="op">=</span> Z_export.dtype,</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>            crs <span class="op">=</span> proj,</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>            transform <span class="op">=</span> transform,</span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>    ) <span class="im">as</span> new_dataset:</span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>            new_dataset.write(Z_export, <span class="dv">1</span>)</span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Export raster</span></span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a>kde_filename <span class="op">=</span> <span class="ss">f"C:/Users/Nissim/Desktop/Vacant Lots Project/guncrime_kde_rast_</span><span class="sc">{</span>today<span class="sc">}</span><span class="ss">.tif"</span></span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a>export_kde_raster(Z <span class="op">=</span> Z_sk, XX <span class="op">=</span> XX_sk, YY <span class="op">=</span> YY_sk,</span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a>                  min_x <span class="op">=</span> min_x_sk, max_x <span class="op">=</span> max_x_sk, min_y <span class="op">=</span> min_y_sk, max_y <span class="op">=</span> max_y_sk,</span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a>                  proj <span class="op">=</span> <span class="dv">2272</span>, filename <span class="op">=</span> kde_filename)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>CPLE_AppDefinedError: Deleting C:/Users/Nissim/Desktop/Vacant Lots Project/guncrime_kde_rast_2023_03_02.tif failed: Permission denied</code></pre>
</div>
</div>
<div class="cell" data-execution_count="109">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>src <span class="op">=</span> rasterio.<span class="bu">open</span>(kde_filename)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="110">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.plot <span class="im">import</span> show</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>fix, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>extent <span class="op">=</span> (src.bounds.left, src.bounds.right, src.bounds.bottom, src.bounds.top)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> rasterio.plot.show(src, extent<span class="op">=</span>extent, ax<span class="op">=</span>ax, cmap<span class="op">=</span><span class="st">'Blues'</span>)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>joined_gdf.plot(ax<span class="op">=</span>ax)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="110">
<pre><code>&lt;AxesSubplot: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023_02_02_vacant_lots_layer_files/figure-html/cell-48-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="111">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>coord_list <span class="op">=</span> [(x,y) <span class="cf">for</span> x,y <span class="kw">in</span> <span class="bu">zip</span>(joined_gdf[<span class="st">'centroid'</span>].x, joined_gdf[<span class="st">'centroid'</span>].y)]</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>joined_gdf[<span class="st">'guncrime_density'</span>] <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> src.sample(coord_list)]</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co"># convert 'guncrime_density' column to float</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>joined_gdf[<span class="st">'guncrime_density'</span>] <span class="op">=</span> joined_gdf[<span class="st">'guncrime_density'</span>].astype(<span class="bu">float</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the centroids with the guncrime density as the color</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>joined_gdf.plot(column<span class="op">=</span><span class="st">'guncrime_density'</span>, cmap<span class="op">=</span><span class="st">'Reds'</span>, legend<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="112">
<pre><code>&lt;AxesSubplot: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023_02_02_vacant_lots_layer_files/figure-html/cell-50-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Reclassify data into percentiles.</p>
<div class="cell" data-execution_count="113">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>guncrime_classifier <span class="op">=</span> mapclassify.Percentiles(joined_gdf[<span class="st">'guncrime_density'</span>], pct<span class="op">=</span>[<span class="dv">50</span>, <span class="dv">75</span>, <span class="dv">90</span>, <span class="dv">95</span>, <span class="dv">99</span>, <span class="dv">100</span>])</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>joined_gdf[<span class="st">'guncrime_density'</span>] <span class="op">=</span> joined_gdf[[<span class="st">'guncrime_density'</span>]].<span class="bu">apply</span>(guncrime_classifier)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>joined_gdf[<span class="st">'guncrime_density'</span>] <span class="op">=</span> joined_gdf[<span class="st">'guncrime_density'</span>].replace([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>], [<span class="st">'Bottom 50%'</span>, <span class="st">'Top 50%'</span>, <span class="st">'Top 25%'</span>, <span class="st">'Top 10%'</span>, <span class="st">'Top 5%'</span>, <span class="st">'Top 1%'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="114">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># need to triple check that I'm calculating this right--is it absolute value?</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>tree_classifier <span class="op">=</span> mapclassify.Percentiles(joined_gdf[<span class="st">'tree_canopy_gap'</span>], pct<span class="op">=</span>[<span class="dv">50</span>, <span class="dv">75</span>, <span class="dv">90</span>, <span class="dv">95</span>, <span class="dv">99</span>, <span class="dv">100</span>])</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>joined_gdf[<span class="st">'tree_canopy_gap'</span>] <span class="op">=</span> joined_gdf[[<span class="st">'tree_canopy_gap'</span>]].<span class="bu">apply</span>(tree_classifier)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>joined_gdf[<span class="st">'tree_canopy_gap'</span>] <span class="op">=</span> joined_gdf[<span class="st">'tree_canopy_gap'</span>].replace([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>], [<span class="st">'Bottom 50%'</span>, <span class="st">'Top 50%'</span>, <span class="st">'Top 25%'</span>, <span class="st">'Top 10%'</span>, <span class="st">'Top 5%'</span>, <span class="st">'Top 1%'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="115">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>joined_gdf.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="115">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>ADDRESS</th>
      <th>BLDG_DESC</th>
      <th>OPA_ID</th>
      <th>COUNCILDISTRICT</th>
      <th>ZIPCODE</th>
      <th>type</th>
      <th>OWNER</th>
      <th>public_owner</th>
      <th>COMM_PARTN</th>
      <th>li_complaints</th>
      <th>li_code_violations</th>
      <th>centroid</th>
      <th>neighborhood</th>
      <th>relevant_rcos</th>
      <th>tree_canopy_gap</th>
      <th>guncrime_density</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3232 HENRY AVE</td>
      <td>COM.CONDO.1STY MASONRY</td>
      <td>882921188</td>
      <td>4</td>
      <td>19129</td>
      <td>Lot</td>
      <td>NEWCOURTLAND ELDER SVCS</td>
      <td>False</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>POINT (2687670.347 256881.319)</td>
      <td>Allegheny West</td>
      <td>East Falls Community Council; PO Box 12672, 19...</td>
      <td>Top 50%</td>
      <td>Bottom 50%</td>
    </tr>
    <tr>
      <th>1</th>
      <td>633 N 53RD ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>442316810</td>
      <td>3</td>
      <td>19131</td>
      <td>Lot</td>
      <td>REDEVELOPMENT AUTHORITY OF PHILADELPHIA</td>
      <td>True</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>POINT (2675594.486 242078.492)</td>
      <td>Haddington</td>
      <td>Parkside Association; Parkside Evans Recreatio...</td>
      <td>Bottom 50%</td>
      <td>Top 50%</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2424 N MOLE ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>161064101</td>
      <td>5</td>
      <td>19132</td>
      <td>Lot</td>
      <td>REDEVELOPMENT AUTHORITY OF PHILADELPHIA</td>
      <td>True</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>POINT (2694579.519 249996.821)</td>
      <td>Stanton</td>
      <td>Uptown Entertainment and Development Corporati...</td>
      <td>Bottom 50%</td>
      <td>Top 5%</td>
    </tr>
    <tr>
      <th>3</th>
      <td>437 ARLINGTON ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>183194500</td>
      <td>7</td>
      <td>19122</td>
      <td>Lot</td>
      <td>MCHUGH JOHN</td>
      <td>False</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>POINT (2699241.653 246723.548)</td>
      <td>West Kensington</td>
      <td>Zulu Nation RCO; 2045 N Lawrence Street\r\nPhi...</td>
      <td>Top 50%</td>
      <td>Top 50%</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2735 N HICKS ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>111168200</td>
      <td>8</td>
      <td>19132</td>
      <td>Lot</td>
      <td>VICTORIA; HERBERT MITCHELL</td>
      <td>False</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>POINT (2695050.897 251708.887)</td>
      <td>Stanton</td>
      <td>Tioga United, Inc.; 1539 W. Venango Street \r\...</td>
      <td>Top 10%</td>
      <td>Top 1%</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now join the poly_gdf back to the joined_gdf on the opa_id column</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>joined_gdf <span class="op">=</span> joined_gdf.join(poly_gdf.set_index(<span class="st">'OPA_ID'</span>), on<span class="op">=</span><span class="st">'OPA_ID'</span>)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co"># drop the 'centroids' column</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>joined_gdf <span class="op">=</span> joined_gdf.drop(columns<span class="op">=</span>[<span class="st">'centroid'</span>])</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="co"># make 'geometry' the geometry column</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>joined_gdf <span class="op">=</span> joined_gdf.set_geometry(<span class="st">'geometry'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="117">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set all column names to lowercase</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>joined_gdf.columns <span class="op">=</span> <span class="bu">map</span>(<span class="bu">str</span>.lower, joined_gdf.columns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="118">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>joined_gdf.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="118">
<pre><code>(35998, 16)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="119">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loop through joined_gdf and return one row per guncrime_density category</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>guncrime_df <span class="op">=</span> pd.DataFrame()</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> joined_gdf[<span class="st">'guncrime_density'</span>].unique():</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    temp_df <span class="op">=</span> joined_gdf[joined_gdf[<span class="st">'guncrime_density'</span>] <span class="op">==</span> i]</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    guncrime_df <span class="op">=</span> guncrime_df.append(temp_df.sample(n<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>guncrime_df.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\Nissim\AppData\Local\Temp\ipykernel_59672\3508243800.py:5: FutureWarning: The frame.append method is deprecated and will be removed from pandas in a future version. Use pandas.concat instead.
  guncrime_df = guncrime_df.append(temp_df.sample(n=1))
C:\Users\Nissim\AppData\Local\Temp\ipykernel_59672\3508243800.py:5: FutureWarning: The frame.append method is deprecated and will be removed from pandas in a future version. Use pandas.concat instead.
  guncrime_df = guncrime_df.append(temp_df.sample(n=1))
C:\Users\Nissim\AppData\Local\Temp\ipykernel_59672\3508243800.py:5: FutureWarning: The frame.append method is deprecated and will be removed from pandas in a future version. Use pandas.concat instead.
  guncrime_df = guncrime_df.append(temp_df.sample(n=1))
C:\Users\Nissim\AppData\Local\Temp\ipykernel_59672\3508243800.py:5: FutureWarning: The frame.append method is deprecated and will be removed from pandas in a future version. Use pandas.concat instead.
  guncrime_df = guncrime_df.append(temp_df.sample(n=1))
C:\Users\Nissim\AppData\Local\Temp\ipykernel_59672\3508243800.py:5: FutureWarning: The frame.append method is deprecated and will be removed from pandas in a future version. Use pandas.concat instead.
  guncrime_df = guncrime_df.append(temp_df.sample(n=1))
C:\Users\Nissim\AppData\Local\Temp\ipykernel_59672\3508243800.py:5: FutureWarning: The frame.append method is deprecated and will be removed from pandas in a future version. Use pandas.concat instead.
  guncrime_df = guncrime_df.append(temp_df.sample(n=1))</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="119">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>address</th>
      <th>bldg_desc</th>
      <th>opa_id</th>
      <th>councildistrict</th>
      <th>zipcode</th>
      <th>type</th>
      <th>owner</th>
      <th>public_owner</th>
      <th>comm_partn</th>
      <th>li_complaints</th>
      <th>li_code_violations</th>
      <th>neighborhood</th>
      <th>relevant_rcos</th>
      <th>tree_canopy_gap</th>
      <th>guncrime_density</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>34466</th>
      <td>2522 S MILLICK ST</td>
      <td>ROW 2 STY MASONRY</td>
      <td>402050300</td>
      <td>2</td>
      <td>19142</td>
      <td>Building</td>
      <td>PRIDGEN EDWARD K</td>
      <td>False</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Elmwood</td>
      <td>Eastwick Friends &amp; Neighbors Coalition; 7720 O...</td>
      <td>Top 25%</td>
      <td>Bottom 50%</td>
      <td>POLYGON ((2676852.904 225949.755, 2676846.512 ...</td>
    </tr>
    <tr>
      <th>7608</th>
      <td>2466 FRANKFORD AVE</td>
      <td>VAC LAND COMM. &lt; ACRE</td>
      <td>885371200</td>
      <td>1</td>
      <td>19125</td>
      <td>Lot</td>
      <td>TAKANASHI SACHIKO; EBBETT ELLIOTT</td>
      <td>False</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>East Kensington</td>
      <td>East Kensington Neighbors Association; 2439 Am...</td>
      <td>Top 25%</td>
      <td>Top 50%</td>
      <td>POLYGON ((2703644.816 247580.065, 2703635.366 ...</td>
    </tr>
    <tr>
      <th>27610</th>
      <td>2851 STOUTON ST</td>
      <td>ROW 2 STY MASONRY</td>
      <td>252542300</td>
      <td>7</td>
      <td>19134</td>
      <td>Building</td>
      <td>JAMES JANO</td>
      <td>False</td>
      <td>None</td>
      <td>NaN</td>
      <td>ID STRUCTURE; ARCHITECT/ENGINEER SERVICES; EXT...</td>
      <td>Richmond</td>
      <td>Impact Community Development Corporation; 1952...</td>
      <td>Bottom 50%</td>
      <td>Top 5%</td>
      <td>POLYGON ((2705261.551 250661.868, 2705251.437 ...</td>
    </tr>
    <tr>
      <th>24673</th>
      <td>2953 N HICKS ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>111170100</td>
      <td>8</td>
      <td>19132</td>
      <td>Lot</td>
      <td>PHILADELPHIA LAND BANK</td>
      <td>True</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Glenwood</td>
      <td>Tioga United, Inc.; 1539 W. Venango Street \r\...</td>
      <td>Top 10%</td>
      <td>Top 1%</td>
      <td>POLYGON ((2695344.745 252954.266, 2695342.832 ...</td>
    </tr>
    <tr>
      <th>19027</th>
      <td>1907 W DAUPHIN ST</td>
      <td>VAC LAND RES &lt; ACRE</td>
      <td>162247901</td>
      <td>5</td>
      <td>19132</td>
      <td>Lot</td>
      <td>CITY OF PHILADELPHIA DEPARTMENT OF PUBLIC PROP...</td>
      <td>True</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Stanton</td>
      <td>Temple Area Property Association (TAPA); 1639 ...</td>
      <td>Bottom 50%</td>
      <td>Top 10%</td>
      <td>POLYGON ((2692987.748 249463.277, 2692972.892 ...</td>
    </tr>
    <tr>
      <th>28548</th>
      <td>2711 N TAYLOR ST</td>
      <td>ROW 2 STY MASONRY</td>
      <td>281014800</td>
      <td>4</td>
      <td>19132</td>
      <td>Building</td>
      <td>MAC DEVELOPMENT GROUP LLC</td>
      <td>False</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Allegheny West</td>
      <td>28th Democratic Ward; 2521 N. 30th Street\r\nP...</td>
      <td>Bottom 50%</td>
      <td>Top 25%</td>
      <td>POLYGON ((2690834.849 252131.168, 2690832.589 ...</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="120">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>guncrime_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="120">
<pre><code>Index(['address', 'bldg_desc', 'opa_id', 'councildistrict', 'zipcode', 'type',
       'owner', 'public_owner', 'comm_partn', 'li_complaints',
       'li_code_violations', 'neighborhood', 'relevant_rcos',
       'tree_canopy_gap', 'guncrime_density', 'geometry'],
      dtype='object')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>pct_cmap <span class="op">=</span> {</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Bottom 50%'</span>: <span class="st">'#00876c'</span>,</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Top 50%'</span>: <span class="st">'#61a96e'</span>,</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Top 25%'</span>: <span class="st">'#aac872'</span>,</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Top 10%'</span>: <span class="st">'#f5af5c'</span>, </span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Top 5%'</span> : <span class="st">'#ea784d'</span>,</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Top 1%'</span>: <span class="st">'#d43d51'</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="122">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># solution found here: https://www.earthdatascience.org/courses/scientists-guide-to-plotting-data-in-python/plot-spatial-data/customize-vector-plots/python-customize-map-legends-geopandas/</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot data</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each attribute type and plot it using the colors assigned in the dictionary</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ctype, data <span class="kw">in</span> joined_gdf.groupby(<span class="st">'guncrime_density'</span>):</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the color for each group using the dictionary</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>    color <span class="op">=</span> pct_cmap[ctype]</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot each group using the color defined above</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>    data.plot(color<span class="op">=</span>color,</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>              ax<span class="op">=</span>ax,</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>              label<span class="op">=</span>ctype)</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(title<span class="op">=</span><span class="st">'Philadelphia Vacant Land by Gun Crime'</span>)</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Place legend in the lower right hand corner of the plot</span></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">'lower right'</span>,</span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>          fontsize<span class="op">=</span><span class="dv">15</span>,</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>          frameon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\Nissim\AppData\Local\Temp\ipykernel_59672\3075049704.py:20: UserWarning: Legend does not support handles for PatchCollection instances.
See: https://matplotlib.org/stable/tutorials/intermediate/legend_guide.html#implementing-a-custom-legend-handler
  ax.legend(loc='lower right',
No artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023_02_02_vacant_lots_layer_files/figure-html/cell-60-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="123">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot data</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each attribute type and plot it using the colors assigned in the dictionary</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ctype, data <span class="kw">in</span> joined_gdf.groupby(<span class="st">'tree_canopy_gap'</span>):</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the color for each group using the dictionary</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    color <span class="op">=</span> pct_cmap[ctype]</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot each group using the color defined above</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>    data.plot(color<span class="op">=</span>color,</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>              ax<span class="op">=</span>ax,</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>              label<span class="op">=</span>ctype)</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>ax.legend(bbox_to_anchor<span class="op">=</span>(<span class="fl">1.0</span>, <span class="fl">.5</span>), prop<span class="op">=</span>{<span class="st">'size'</span>: <span class="dv">12</span>})</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(title<span class="op">=</span><span class="st">'Philadelphia Vacant Land by Tree Canopy Gap'</span>)</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\Nissim\AppData\Local\Temp\ipykernel_59672\420939947.py:15: UserWarning: Legend does not support handles for PatchCollection instances.
See: https://matplotlib.org/stable/tutorials/intermediate/legend_guide.html#implementing-a-custom-legend-handler
  ax.legend(bbox_to_anchor=(1.0, .5), prop={'size': 12})
No artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023_02_02_vacant_lots_layer_files/figure-html/cell-61-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="124">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># reproject to 4326 for mapping</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>joined_gdf <span class="op">=</span> joined_gdf.to_crs(epsg<span class="op">=</span><span class="dv">4326</span>)</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co"># simplify the geometry</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>joined_gdf[<span class="st">'geometry'</span>] <span class="op">=</span> joined_gdf[<span class="st">'geometry'</span>].simplify(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="127">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>joined_gdf.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="127">
<pre><code>(35998, 16)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="125">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># need to add a column for lot size (total area)</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the can convert geoms to points</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="co"># remember--originally wanted to display lots and buildings with separate icons. Do I still want to?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="126">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># write the joined_gdf to a geojson</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>joined_gdf.to_file(<span class="st">"C:/Users/Nissim/Desktop/Vacant Lots Project/vacant-lots-proj/vacancy_guncrime_dash/joined_gdf.geojson"</span>, driver<span class="op">=</span><span class="st">'GeoJSON'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>